<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cyclone Community Help Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      max-width:680px;
      margin:0 auto;
      height:100vh;
      display:flex;
      flex-direction:column;
      background:#fafafa;
    }
    header{
      background:#b00020;
      color:#fff;
      padding:8px 10px;
      font-size:15px;
    }
    header h1{
      font-size:16px;
      font-weight:600;
    }
    header p{
      font-size:12px;
      margin-top:4px;
      opacity:0.9;
    }
    #me{
      font-size:12px;
      opacity:0.9;
      margin-top:6px;
    }
    #alertBanner{
      background:#fff3cd;
      color:#664d03;
      padding:8px 10px;
      font-size:12px;
      border-bottom:1px solid #ffeeba;
    }
    #log{
      flex:1;
      overflow-y:auto;
      padding:8px;
      background:#eee;
    }
    .m{
      margin:4px 0;
      padding:6px 10px;
      border-radius:12px;
      max-width:80%;
      font-size:14px;
      line-height:1.3;
      word-wrap:break-word;
    }
    .me{
      background:#cfefff;
      margin-left:auto;
      border:1px solid #9bc5e8;
    }
    .comm{
      background:#ffffff;
      margin-right:auto;
      border:1px solid #d4d4d4;
    }
    .vol{
      background:#e3f2fd;
      margin-right:auto;
      border:1px solid #90caf9;
    }
    .meta{
      display:block;
      font-size:11px;
      opacity:0.8;
      margin-bottom:2px;
    }
    .sys{
      background:#ffe0e0;
      margin:6px auto;
      border:1px dashed #d32f2f;
      font-size:12px;
      max-width:90%;
    }
    form{
      display:flex;
      padding:8px;
      background:#ddd;
      gap:6px;
    }
    input[type=text]{
      flex:1;
      border-radius:16px;
      border:1px solid #bbb;
      padding:8px 10px;
      font-size:14px;
    }
    button{
      border:none;
      border-radius:16px;
      padding:8px 14px;
      font-size:14px;
      background:#b00020;
      color:#fff;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>Cyclone Community Help Chat</h1>
    <p>Connect with volunteers during the Mangla cyclone alert.</p>
    <div id="me">
      You: <span id="myName">...</span> — Role: <span id="myRole">...</span>
    </div>
  </header>

  <div id="alertBanner">
    <strong>Alert:</strong> Cyclone approaching the Mangla coast. This chat helps coordinate local support.
  </div>

  <div id="log"></div>

  <form id="f">
    <input id="msg" type="text" autocomplete="off" placeholder="Type your cyclone update or request…">
    <button type="submit">Send</button>
  </form>

<script>
  const log = document.getElementById('log');
  const form = document.getElementById('f');
  const msg  = document.getElementById('msg');
  const myNameSpan = document.getElementById('myName');
  const myRoleSpan = document.getElementById('myRole');
  let lastSeq = 0;
  let myName = "";
  let myRole = "";

  function addDemoMessages(){
    const demo = [
      { seq: 1, name: "community|Rahim", text: "Water level rising near Mangla Bazar. 5 families stranded." },
      { seq: 2, name: "volunteer|Ayesha", text: "Acknowledged. Sending team towards Bazar. Any children or elderly?" },
      { seq: 3, name: "community|Rahim", text: "Yes, 2 elderly people and 1 child. Roads partially flooded." },
      { seq: 4, name: "volunteer|Ayesha", text: "Understood. Our boat team will reach in approx 20 minutes. Stay together." },
      { seq: 5, name: "community|Jamal", text: "Electricity gone near New Para. Anyone has updates?" }
    ];
    demo.forEach(addMessage);
    lastSeq = 5;
  }

  function askProfile(){
    myName = localStorage.getItem('loraName') || "";
    myRole = localStorage.getItem('loraRole') || "";

    while(!myName){
      myName = prompt("Enter your name:");
      if(myName) myName = myName.trim();
      if(myName) localStorage.setItem('loraName', myName);
    }

    while(!myRole){
      let role = prompt("Are you a community member or volunteer? (community/volunteer)").trim().toLowerCase();
      if(role === "community" || role === "volunteer"){
        myRole = role;
        localStorage.setItem('loraRole', myRole);
      }
    }

    myNameSpan.textContent = myName;
    myRoleSpan.textContent = myRole;
  }

  function addMessage(m){
    let raw = m.name;
    let role = raw.split("|")[0];
    let name = raw.split("|")[1];

    const d = document.createElement('div');

    if(name === myName && role === myRole){
      d.className = 'm me';
    } else if(role === 'volunteer'){
      d.className = 'm vol';
    } else {
      d.className = 'm comm';
    }

    d.innerHTML = '<span class="meta">' + role + ' — ' + name + '</span>' + m.text;
    log.appendChild(d);
    log.scrollTop = log.scrollHeight;
  }

  async function poll(){
    try{
      const r = await fetch('/poll?since=' + lastSeq);
      const arr = await r.json();
      arr.forEach(m => {
        addMessage(m);
        if(m.seq > lastSeq) lastSeq = m.seq;
      });
    }catch(e){}
    setTimeout(poll, 1000);
  }

  form.onsubmit = async e => {
    e.preventDefault();
    const t = msg.value.trim();
    if(!t) return;
    msg.value = "";
    try{
      const full = myRole + "|" + myName;
      await fetch('/send?name=' + encodeURIComponent(full) +
                  '&txt=' + encodeURIComponent(t));
    }catch(e){}
  };

  askProfile();
  addDemoMessages();
  poll();
</script>
</body>
</html>
