<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Mesh Message Flow — Minimal Mobile</title>
<style>
  :root { --bg:#0b1020; --panel:#121935; --ink:#eaf0ff; --muted:#a9b7ff; --accent:#68a0ff; --ok:#36d28a; --err:#ff6b6b; --line:#26366f; --sheet:#0d1430; }
  * { box-sizing:border-box; }
  html, body { height:100%; margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  .app { display:grid; grid-template-columns: 360px 1fr; height:100%; }
  .side { background:var(--panel); border-right:1px solid #223064; padding:14px; display:flex; flex-direction:column; gap:12px; }
  h1 { font-size:18px; margin:0; }
  .muted { color:var(--muted); font-size:12px; }
  .box { background:var(--sheet); border:1px solid var(--line); border-radius:16px; padding:12px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
  input, button, select { font:inherit; }
  button { background:#1f66ff; color:#fff; border:0; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; }
  button.ghost { background:transparent; border:1px solid #3651a9; color:#cfe1ff; }
  select, input[type="number"], input[type="text"] { width:100%; padding:8px 10px; border-radius:12px; border:1px solid #2a3a78; background:#0b1230; color:#eaf0ff; }
  .trace { height:220px; overflow:auto; background:#0a1231; border:1px solid var(--line); border-radius:12px; padding:8px; font-size:13px; }
  .legend { font-size:12px; }
  .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
  .on { background:var(--ok); } .off { background:var(--err); } .tx { background:var(--accent); }
  .canvasWrap { position:relative; background:linear-gradient(180deg,#0b1020,#0e1531); }
  canvas { display:block; width:100%; height:100%; touch-action:none; }

  /* Floating actions (mobile) */
  .fab { position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:10px; z-index:20; }
  .fab button { padding:14px 16px; border-radius:999px; box-shadow:0 6px 20px #0006; }

  /* Bottom sheet for Send (mobile) */
  .sheet {
    position:fixed; left:0; right:0; bottom:0; background:var(--panel);
    border-top-left-radius:18px; border-top-right-radius:18px;
    box-shadow:0 -10px 30px #0008; transform:translateY(100%); transition:transform .25s ease; z-index:30;
    max-height:70vh; padding:12px;
  }
  .sheet.open { transform:translateY(0); }
  .grab { width:54px; height:6px; border-radius:3px; background:#31407a; margin:6px auto 12px; }

  /* Responsive: hide sidebar on mobile; show FAB+sheet only */
  @media (max-width: 900px) {
    .app { grid-template-columns: 1fr; }
    .side { display:none; }
    .canvasWrap { height:100svh; }
  }
  @media (min-width: 901px) {
    .fab, .sheet { display:none; }
    .canvasWrap { height:100%; }
  }
</style>
</head>
<body>
<div class="app">
  <!-- Desktop sidebar (full controls remain for desktop) -->
  <aside class="side">
    <div>
      <h1>Mesh Message Flow</h1>
      <div class="muted">ESP32 AP + LoRa hops. Desktop has full controls; mobile shows only Add + Send.</div>
    </div>

    <div class="box">
      <div class="row">
        <button id="send">Send</button>
        <button id="reset" class="ghost">Reset</button>
        <button id="randomize" class="ghost">Randomize</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Sender</label><select id="sender"></select></div>
        <div style="flex:1"><label>TTL</label><input id="ttl" type="number" min="1" max="10" value="5" /></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1"><label>Per-hop delay (ms)</label><input id="delay" type="number" min="50" step="50" value="1000" /></div>
        <div style="flex:1"><label>Packet loss (%)</label><input id="loss" type="number" min="0" max="50" value="5" /></div>
      </div>
      <div style="margin-top:8px"><label>Message</label><input id="msg" type="text" value="Evacuate to shelter Level-2" /></div>
      <div class="row" style="margin-top:8px"><button id="addNode" class="ghost">Add Node</button><button id="toggleLinks" class="ghost">Toggle Links</button></div>
    </div>

    <div class="box">
      <div class="legend">
        <div><span class="dot on"></span>Node ON</div>
        <div><span class="dot tx"></span>Transmitting</div>
        <div><span class="dot off"></span>Node OFF</div>
      </div>
      <div id="trace" class="trace" style="margin-top:8px"></div>
    </div>
  </aside>

  <!-- Canvas -->
  <main class="canvasWrap">
    <canvas id="cv"></canvas>
  </main>
</div>

<!-- Mobile-only floating actions -->
<div class="fab">
  <button id="fabAdd">Add Node</button>
  <button id="fabSend" style="background:#1f66ff;">Send</button>
</div>

<!-- Mobile-only send sheet -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="grab"></div>
  <div class="row">
    <div style="flex:1"><label>Sender</label><select id="mSender"></select></div>
    <div style="width:100px"><label>TTL</label><input id="mTTL" type="number" min="1" max="10" value="5" /></div>
  </div>
  <div style="margin-top:8px"><label>Message</label><input id="mMsg" type="text" placeholder="Type message…" value="Evacuate to shelter Level-2" /></div>
  <div class="row" style="margin-top:10px">
    <button id="mSend">Send</button>
    <button id="mClose" class="ghost">Close</button>
  </div>
</div>

<script>
/* ---------- Utilities & Canvas ---------- */
const $ = id => document.getElementById(id);
const cv = $('cv'), ctx = cv.getContext('2d');
let W = cv.width = innerWidth, H = cv.height = innerHeight;
addEventListener('resize', () => { W = cv.width = innerWidth; H = cv.height = innerHeight; draw(); });
const now = () => performance.now();
const rnd = (a,b)=>Math.random()*(b-a)+a;

/* ---------- Camera ---------- */
let cam = { x:0, y:0, s:1 };
const toS = (x,y)=>({ x:(x+cam.x)*cam.s, y:(y+cam.y)*cam.s });
const toW = (x,y)=>({ x:x/cam.s - cam.x, y:y/cam.s - cam.y });

/* ---------- Model ---------- */
let nodes = [], edges = [], packets = [];
const RADIUS = 18, DEFAULT_RANGE = 1200;
let idCounter = 1;
let showLinks = true;

/* Desktop-only tunables (mobile keeps defaults) */
const TUNABLES = {
  get delay(){ const d = $('delay'); return d ? (+d.value||1000) : 1000; },
  get loss(){ const l = $('loss'); return l ? (+l.value||5) : 5; },
  get ttl(){ const t = $('ttl'); return t ? (+t.value||5) : 5; },
  get msg(){ const m = $('msg'); return m ? (m.value||'').trim() : ''; },
  set ttl(v){ if($('ttl')) $('ttl').value = v; },
  set msg(v){ if($('msg')) $('msg').value = v; }
};

/* ---------- Init scene ---------- */
function makeNode(name, x, y, range=DEFAULT_RANGE){ return { id:name, x, y, on:true, range, tx:0, buffer:[], seen:new Set() }; }
function seed(){
  nodes = [
    makeNode('LoRaChat-Shelter-A', W*0.28, H*0.60),
    makeNode('LoRaChat-Village',   W*0.50, H*0.30),
    makeNode('LoRaChat-Clinic',    W*0.72, H*0.62),
    makeNode('LoRaChat-School',    W*0.50, H*0.80)
  ];
  idCounter = 5;
  refreshSenders();
  clearTrace();
  recomputeEdges(); draw();
}

/* ---------- Connectivity ---------- */
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy)*2; } // px≈2m
function recomputeEdges(){
  edges = [];
  for(let i=0;i<nodes.length;i++) for(let j=i+1;j<nodes.length;j++){
    const a=nodes[i], b=nodes[j];
    if(a.on && b.on && dist(a,b)<=a.range && dist(a,b)<=b.range) edges.push([a,b]);
  }
}
function neighbors(n){
  return nodes.filter(m => m!==n && m.on && n.on && dist(n,m)<=n.range && dist(n,m)<=m.range);
}

/* ---------- Trace (desktop only; mobile intentionally hidden) ---------- */
function clearTrace(){ const t=$('trace'); if(t) t.innerHTML=''; }
function trace(line){ const t=$('trace'); if(t){ const p=document.createElement('div'); p.textContent=line; t.appendChild(p); t.scrollTop=t.scrollHeight; } }

/* ---------- Messaging ---------- */
function animateHop(from, to){
  const a = toS(from.x, from.y), b = toS(to.x, to.y);
  packets.push({ ax:a.x, ay:a.y, bx:b.x, by:b.y, t0:now(), dur: Math.max(250, TUNABLES.delay*0.6) });
  from.tx = 1;
}
function deliverLocal(n, pkt){
  n.seen.add(pkt.id);
  if(n.buffer.length>=50) n.buffer.shift();
  n.buffer.push(`${pkt.name}: ${pkt.text}`);
  trace(`${n.id} received (hops=${pkt.hops})`);
}
function flood(from, pkt){
  animateHop(from, from);
  neighbors(from).forEach(nb=>{
    const loss = Math.random()*100 < Math.min(50, Math.max(0, TUNABLES.loss));
    const delay = TUNABLES.delay + Math.floor(Math.random()*250);
    setTimeout(()=>{
      if(loss) { trace(`· dropped en route to ${nb.id}`); return; }
      if(nb.seen.has(pkt.id)) return;
      const next = { ...pkt, hops:pkt.hops+1, ttl:pkt.ttl-1 };
      animateHop(from, nb);
      deliverLocal(nb, next);
      if(next.ttl>0) flood(nb, next);
    }, delay);
  });
}
function send(senderId, text, ttl){
  if(!nodes.length) return;
  const sender = nodes.find(n=>n.id===senderId) || nodes[0];
  if(!sender || !sender.on) { trace('Cannot send: sender is OFF'); return; }
  const pkt = { id:`${Date.now()}-${Math.random().toString(36).slice(2,7)}`, name:'Volunteer', text, ttl, hops:0 };
  deliverLocal(sender, pkt);
  trace(`Sent from ${sender.id} with TTL=${ttl}`);
  flood(sender, pkt);
}

/* ---------- Add node ---------- */
function addNodeAt(x, y){
  const n = makeNode(`LoRaChat-${idCounter++}`, x, y, DEFAULT_RANGE);
  nodes.push(n); refreshSenders(); recomputeEdges(); draw();
}

/* ---------- Populate sender lists (desktop + mobile) ---------- */
function refreshSenders(){
  const fill = (sel)=>{
    if(!sel) return;
    sel.innerHTML=''; nodes.forEach(n=>{ const o=document.createElement('option'); o.value=n.id; o.textContent=n.id; sel.appendChild(o); });
    if(nodes.length) sel.value = nodes[1] ? nodes[1].id : nodes[0].id;
  };
  fill($('sender'));
  fill($('mSender'));
}

/* ---------- Draw ---------- */
function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.scale(cam.s, cam.s); ctx.translate(cam.x, cam.y);

  if(showLinks){
    edges.forEach(([a,b])=>{
      ctx.strokeStyle = 'rgba(90,130,255,0.25)';
      ctx.lineWidth = 1/cam.s;
      ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
    });
  }

  nodes.forEach(n=>{
    // range
    ctx.beginPath(); ctx.arc(n.x, n.y, n.range/2, 0, Math.PI*2);
    ctx.fillStyle = 'rgba(70,90,170,0.08)'; ctx.fill();

    // body
    ctx.beginPath(); ctx.arc(n.x, n.y, RADIUS+2, 0, Math.PI*2);
    ctx.fillStyle = '#0a1444'; ctx.fill();
    ctx.lineWidth = 2/cam.s; ctx.strokeStyle = n.on ? '#36d28a' : '#ff6b6b'; ctx.stroke();

    // inner
    ctx.beginPath(); ctx.arc(n.x, n.y, RADIUS, 0, Math.PI*2);
    const inner = n.on ? (n.tx>0 ? '#68a0ff' : '#a3b6ff') : '#5e2433';
    ctx.fillStyle = inner; ctx.fill();

    // label
    ctx.font = `${12/cam.s}px system-ui, sans-serif`; ctx.textAlign='center';
    ctx.fillStyle='#cfdbff'; ctx.fillText(n.id, n.x, n.y-(RADIUS+10));

    if(n.tx>0) n.tx -= 0.04;
  });

  // packets
  const t = now();
  packets = packets.filter(p=>{
    const k = Math.min(1, (t - p.t0)/p.dur);
    const x = p.ax + (p.bx - p.ax)*k, y = p.ay + (p.by - p.ay)*k;
    ctx.save(); ctx.scale(1/cam.s, 1/cam.s);
    ctx.beginPath(); ctx.arc(x/cam.s - cam.x, y/cam.s - cam.y, 6, 0, Math.PI*2);
    ctx.fillStyle = '#68a0ff'; ctx.fill();
    ctx.restore();
    return k < 1;
  });

  ctx.restore();
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

/* ---------- Interactions ---------- */
let dragging=null;

function worldFromEvent(e){
  const rect = cv.getBoundingClientRect();
  const x = (e.clientX - rect.left), y = (e.clientY - rect.top);
  return toW(x, y);
}

/* Mouse (desktop) */
cv.addEventListener('mousedown', e=>{
  const w = worldFromEvent(e);
  // drag if node; else no-op for minimal build
  for(let i=nodes.length-1;i>=0;i--){
    const n = nodes[i]; if(Math.hypot(w.x-n.x,w.y-n.y)<=RADIUS+4){ dragging={id:n.id, dx:w.x-n.x, dy:w.y-n.y}; return; }
  }
});
addEventListener('mousemove', e=>{
  if(!dragging) return;
  const w = worldFromEvent(e); const n = nodes.find(m=>m.id===dragging.id); if(!n) return;
  n.x = w.x - dragging.dx; n.y = w.y - dragging.dy; recomputeEdges();
});
addEventListener('mouseup', ()=> dragging=null);
cv.addEventListener('wheel', e=>{
  const f = Math.sign(e.deltaY)>0 ? 0.9 : 1.1;
  const rect = cv.getBoundingClientRect();
  const before = toW(e.clientX-rect.left, e.clientY-rect.top);
  cam.s = Math.min(2.5, Math.max(0.5, cam.s*f));
  const after = toW(e.clientX-rect.left, e.clientY-rect.top);
  cam.x += (before.x - after.x); cam.y += (before.y - after.y);
});

/* Touch (mobile) — minimal: drag nodes, pinch zoom, long-press to add */
let touchState = { touches:[], pinchStart:null, longPressTimer:null };
cv.addEventListener('touchstart', (e)=>{
  e.preventDefault();
  const list = Array.from(e.touches).map(t=>({ x:t.clientX, y:t.clientY }));
  touchState.touches = list;

  if(list.length===1){
    const w = worldFromEvent(e.touches[0]);
    for(let i=nodes.length-1;i>=0;i--){
      const n = nodes[i]; if(Math.hypot(w.x-n.x,w.y-n.y)<=RADIUS+4){ dragging={id:n.id, dx:w.x-n.x, dy:w.y-n.y}; break; }
    }
    clearTimeout(touchState.longPressTimer);
    touchState.longPressTimer = setTimeout(()=>{ if(!dragging){ const ww = worldFromEvent(e.touches[0]); addNodeAt(ww.x, ww.y); } }, 550);
  } else if(list.length===2){
    clearTimeout(touchState.longPressTimer);
    touchState.pinchStart = {
      d: Math.hypot(list[0].x - list[1].x, list[0].y - list[1].y),
      camS: cam.s
    };
  }
});
cv.addEventListener('touchmove', (e)=>{
  e.preventDefault();
  const list = Array.from(e.touches).map(t=>({ x:t.clientX, y:t.clientY }));
  touchState.touches = list;
  clearTimeout(touchState.longPressTimer);

  if(list.length===1){
    const w = toW(list[0].x - cv.getBoundingClientRect().left, list[0].y - cv.getBoundingClientRect().top);
    if(dragging && dragging.id){
      const n = nodes.find(m=>m.id===dragging.id); if(!n) return;
      n.x = w.x - dragging.dx; n.y = w.y - dragging.dy; recomputeEdges();
    }
  } else if(list.length===2 && touchState.pinchStart){
    const dNow = Math.hypot(list[0].x - list[1].x, list[0].y - list[1].y);
    let factor = dNow / touchState.pinchStart.d;
    cam.s = Math.min(2.5, Math.max(0.5, touchState.pinchStart.camS * factor));
  }
});
cv.addEventListener('touchend', (e)=>{ clearTimeout(touchState.longPressTimer); dragging=null; if(e.touches.length<2) touchState.pinchStart=null; });

/* ---------- Desktop controls ---------- */
const dSend = ()=> {
  const sender = ($('sender') && $('sender').value) || (nodes[0] && nodes[0].id);
  const txt = TUNABLES.msg || 'Evacuate to shelter Level-2';
  const ttl = Math.max(1, Math.min(10, TUNABLES.ttl || 5));
  send(sender, txt, ttl);
};
$('send').onclick = dSend;
$('reset').onclick = seed;
$('randomize').onclick = ()=>{ nodes.forEach(n=>{ n.x=rnd(W*0.15,W*0.85); n.y=rnd(H*0.15,H*0.85); }); recomputeEdges(); draw(); };
$('addNode').onclick = ()=>{ const w = toW(W*0.5, H*0.5); addNodeAt(w.x, w.y); };
$('toggleLinks').onclick = ()=>{ showLinks=!showLinks; draw(); };

/* ---------- Mobile: FAB + Sheet ---------- */
const sheet = $('sheet');
$('fabSend').onclick = ()=>{ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); };
$('mClose').onclick = ()=>{ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); };

$('fabAdd').onclick = ()=>{ const w = toW(W*0.5, H*0.6); addNodeAt(w.x, w.y); };
$('mSend').onclick = ()=> {
  const sender = $('mSender').value || (nodes[0] && nodes[0].id);
  const txt = ($('mMsg').value||'').trim(); if(!txt) return;
  const ttl = Math.max(1, Math.min(10, +$('mTTL').value||5));
  send(sender, txt, ttl);
  sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true');
};

/* ---------- Start ---------- */
seed();
</script>
</body>
</html>
